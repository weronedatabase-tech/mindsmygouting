<!DOCTYPE html>
<html>
 <head>
   <base target="_blank">
   <script src="https://cdn.tailwindcss.com"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <style>
     ::-webkit-scrollbar { width: 8px; }
     ::-webkit-scrollbar-track { background: #1e293b; }
     ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
     .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
     @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
     .fade-in { animation: fadeIn 0.3s ease-in-out; }
     @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
     .search-results { max-height: 250px; overflow-y: auto; }
     .modal-content { max-height: 80vh; }
     body { -webkit-tap-highlight-color: transparent; }
   </style>
 </head>
 <body class="bg-slate-900 min-h-screen font-sans text-slate-200 pb-20">

   <!-- CONFIGURATION & API HANDLER -->
   <script>
       const FRONTEND_DEFAULT_ENV = 'PROD'; 
       const APIS = {
           DEV: 'https://script.google.com/macros/s/AKfycbywS4uXR4G_S-Xqvqrkohckp76SEzp78dIyOLwBp6a5pLtHjUxwGjDyo4grEsHxerta/exec',
           PROD: 'https://script.google.com/macros/s/AKfycbwOQHiPXoVB10_T81K1mfWPZyahHFXHnrbR7KuM4GI0tQjnsaGjQMunDJWcXRP5g0aENQ/exec'
       };

       // Environment Logic
       const urlParams = new URLSearchParams(window.location.search);
       let currentEnv = FRONTEND_DEFAULT_ENV;
       if (urlParams.has('env')) {
           currentEnv = urlParams.get('env') === 'dev' ? 'DEV' : 'PROD';
       }
       const ACTIVE_API_URL = APIS[currentEnv];
       console.log(`Running in ${currentEnv} mode connected to: ${ACTIVE_API_URL}`);

       async function apiCall(action, data = {}) {
           try {
               const response = await fetch(ACTIVE_API_URL, {
                   method: 'POST',
                   body: JSON.stringify({ action: action, data: data }),
                   headers: { 'Content-Type': 'text/plain;charset=utf-8' } 
               });
               const json = await response.json();
               return json;
           } catch (error) {
               console.error("API Error:", error);
               return { success: false, message: "Connection Error. Please check internet." };
           }
       }
   </script>

   <!-- STICKY HEADER -->
   <div class="sticky top-0 z-50 shadow-lg">
     <div id="devBar" class="hidden bg-red-600 text-white text-center text-xs font-bold py-1 border-b border-red-800">DEV MODE</div>
     <script>if (currentEnv === 'DEV') document.getElementById('devBar').classList.remove('hidden');</script>

     <nav class="bg-slate-800/90 backdrop-blur-md border-b border-slate-700">
       <div class="container mx-auto px-4 py-4 flex items-center justify-between">
         <div class="flex items-center gap-3 cursor-pointer" onclick="showView('landing')">
           <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-500/20">
             <i class="fa-solid fa-calendar-days text-white text-xl"></i>
           </div>
           <div>
             <h1 class="text-lg font-bold text-white leading-tight">MINDS MYG</h1>
             <p class="text-xs text-slate-400">Outings Organiser</p>
           </div>
         </div>
         <div class="flex items-center gap-4">
             <button onclick="refreshApp()" class="text-slate-400 hover:text-white text-sm transition-colors group" title="Force Refresh Data">
                 <i id="refreshIcon" class="fa-solid fa-arrows-rotate group-hover:text-blue-400"></i>
                 <span class="hidden sm:inline ml-1">Refresh</span>
             </button>
             <div class="h-4 w-px bg-slate-700"></div>
             <button onclick="showView('landing')" class="text-slate-400 hover:text-white text-sm transition-colors">
                 <i class="fa-solid fa-house"></i>
                 <span class="hidden sm:inline ml-1">Home</span>
             </button>
         </div>
       </div>
     </nav>
   </div>

   <!-- MAIN CONTENT -->
   <main class="container mx-auto p-4 mt-4 max-w-xl">
     
     <!-- LANDING PAGE -->
     <div id="view-landing" class="fade-in space-y-4">
       <h2 class="text-xl font-bold text-center text-white mb-6">Select Profile</h2>
       <div onclick="requestAccess('comm')" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-500/50 rounded-2xl p-6 cursor-pointer transition-all shadow-lg flex items-center gap-4 group">
         <div class="bg-blue-900/50 p-4 rounded-xl text-blue-400 group-hover:scale-110 transition-transform"><i class="fa-solid fa-user-tie text-2xl"></i></div>
         <div><h3 class="text-lg font-bold text-white">Comm Profile</h3><p class="text-sm text-slate-400">Create outings & scrub data</p></div>
       </div>
       <div onclick="showView('volunteer')" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-green-500/50 rounded-2xl p-6 cursor-pointer transition-all shadow-lg flex items-center gap-4 group">
         <div class="bg-green-900/50 p-4 rounded-xl text-green-400 group-hover:scale-110 transition-transform"><i class="fa-solid fa-users text-2xl"></i></div>
         <div><h3 class="text-lg font-bold text-white">Volunteer & Trainee</h3><p class="text-sm text-slate-400">Update attendance</p></div>
       </div>
       <div onclick="requestAccess('settings')" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-purple-500/50 rounded-2xl p-6 cursor-pointer transition-all shadow-lg flex items-center gap-4 group">
         <div class="bg-purple-900/50 p-4 rounded-xl text-purple-400 group-hover:scale-110 transition-transform"><i class="fa-solid fa-sliders text-2xl"></i></div>
         <div><h3 class="text-lg font-bold text-white">Settings</h3><p class="text-sm text-slate-400">Configure attendance fields</p></div>
       </div>
     </div>

     <!-- AUTH MODAL -->
     <div id="authModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-sm rounded-2xl border border-slate-700 p-6 shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold text-white mb-4 text-center">Restricted Access</h3>
            <p class="text-sm text-slate-400 mb-4 text-center">Please enter the admin password.</p>
            <form onsubmit="handleAuth(event)">
                <input type="password" id="adminPassword" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white text-center tracking-widest focus:border-blue-500 outline-none mb-4" placeholder="Password" required>
                <div id="authError" class="hidden text-red-400 text-xs text-center mb-3 font-bold">Incorrect Password</div>
                <div class="flex gap-2">
                    <button type="button" onclick="closeAuthModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 rounded-lg">Cancel</button>
                    <button type="submit" id="authBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg">Access</button>
                </div>
            </form>
        </div>
     </div>

     <!-- COMM VIEW -->
     <div id="view-comm" class="hidden fade-in space-y-6">
       <div class="flex items-center gap-2 mb-2"><button onclick="showView('landing')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-arrow-left"></i> Back</button><h2 class="text-xl font-bold text-blue-400">Comm Dashboard</h2></div>
       <div id="commGlobalStatus" class="hidden mb-4 p-3 rounded-lg text-sm text-center"></div>
       <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 shadow-xl">
          <h3 class="font-bold text-white mb-2"><i class="fa-solid fa-folder-plus text-blue-500 mr-2"></i>Create New Outing</h3>
          <button onclick="openModal()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all text-sm">Create Outing</button>
       </div>
       <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 shadow-xl">
          <h3 class="font-bold text-white mb-2"><i class="fa-solid fa-user-group text-teal-500 mr-2"></i>Auto Pairing and Grouping</h3>
          <div class="relative mb-3">
            <label class="text-[10px] text-slate-400 uppercase font-bold mb-1 block flex items-center gap-1">Select Event <span id="commSheetLoading" class="hidden"><i class="fa-solid fa-circle-notch fa-spin text-teal-500"></i></span></label>
            <select id="commSheetSelector" class="w-full bg-slate-900 border border-slate-600 rounded-lg py-2 px-3 text-sm focus:border-teal-500 outline-none text-white"><option disabled selected>Loading...</option></select>
          </div>
          <div class="flex gap-2 mt-3">
             <button id="scrubBtn" onclick="handlePair()" class="flex-1 bg-slate-700 hover:bg-teal-600 hover:text-white text-teal-400 border border-teal-500/30 font-bold py-3 rounded-xl transition-all text-sm">Pair Now</button>
             <button id="groupBtn" onclick="handleGroup()" class="flex-1 bg-slate-700 hover:bg-purple-600 hover:text-white text-purple-400 border border-purple-500/30 font-bold py-3 rounded-xl transition-all text-sm">Group Now</button>
          </div>
          <div id="scrubStatus" class="hidden mt-4 p-3 bg-slate-900 rounded-xl text-xs whitespace-pre-wrap font-mono border border-slate-700"></div>
       </div>
       <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 shadow-xl">
          <h3 class="font-bold text-white mb-3"><i class="fa-solid fa-list-ul text-purple-500 mr-2"></i>Upcoming Outings</h3>
          <div id="upcomingList" class="space-y-4 text-sm text-slate-400"><p class="text-xs italic"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading events...</p></div>
       </div>
     </div>

     <!-- VOLUNTEER VIEW -->
     <div id="view-volunteer" class="hidden fade-in space-y-6">
       <div class="flex items-center gap-2 mb-2"><button onclick="showView('landing')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-arrow-left"></i> Back</button><h2 class="text-xl font-bold text-green-400">Attendance Update</h2></div>
       <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 shadow-xl space-y-4">
           <div class="relative"><label class="text-xs font-bold text-green-400 uppercase flex items-center gap-2">1. Select Upcoming Event <span id="volSheetLoading" class="hidden"><i class="fa-solid fa-spinner fa-spin"></i></span></label><div class="relative mt-1"><select id="volSheetSelector" class="w-full mt-1 bg-slate-900 border border-slate-600 rounded-lg py-3 px-3 text-sm text-white focus:border-green-500 outline-none appearance-none" onchange="resetVolForm()"><option disabled selected>Loading...</option></select><div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-500"><i class="fa-solid fa-chevron-down"></i></div><div id="volSheetSpinner" class="absolute right-8 top-3 hidden pointer-events-none text-green-500"><i class="fa-solid fa-circle-notch fa-spin"></i></div></div></div>
           <div><label class="text-xs font-bold text-green-400 uppercase">2. Select Type</label><div class="flex gap-2 mt-1"><button type="button" onclick="setVolType('trainee', this)" class="vol-type-btn flex-1 bg-slate-900 border border-slate-600 hover:border-green-500 py-3 rounded-lg text-sm transition-colors text-slate-300">Trainee</button><button type="button" onclick="setVolType('volunteer', this)" class="vol-type-btn flex-1 bg-slate-900 border border-slate-600 hover:border-green-500 py-3 rounded-lg text-sm transition-colors text-slate-300">Volunteer</button></div></div>
           <div id="volNameSection" class="hidden"><label class="text-xs font-bold text-green-400 uppercase">3. Search / Select Name</label><div class="relative mt-1"><div class="relative"><div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i class="fa-solid fa-magnifying-glass text-slate-500"></i></div><input type="text" id="volNameSearch" class="w-full bg-slate-900 border border-slate-600 rounded-lg py-3 pl-10 pr-10 text-sm text-white focus:border-green-500 outline-none placeholder-slate-500" placeholder="Type to search..." onfocus="autoScrollAndFocus(this)" oninput="filterNames()" autocomplete="off"><div id="nameLoader" class="absolute right-3 top-3 hidden"><div class="text-slate-400 text-xs"><i class="fa-solid fa-circle-notch fa-spin"></i></div></div><button onclick="clearSearch()" id="clearSearchBtn" class="absolute right-3 top-3 text-slate-500 hover:text-white hidden z-20"><i class="fa-solid fa-times"></i></button></div><ul id="volNameList" class="absolute z-50 w-full bg-slate-800 border-2 border-cyan-500 rounded-xl mt-2 shadow-[0_0_20px_rgba(6,182,212,0.3)] hidden max-h-60 overflow-y-auto"></ul></div><div id="addNewVolContainer" class="hidden mt-3 text-center"><button type="button" onclick="showAddNewForm()" class="text-sm text-green-400 hover:text-green-300 font-bold flex items-center justify-center gap-2 w-full py-2 bg-slate-700/50 rounded-lg border border-dashed border-green-500/30"><i class="fa-solid fa-user-plus"></i> Ôºã Can't find your name above? Add yourself in here</button></div></div>
       </div>
       <div id="volFormContainer" class="hidden bg-slate-800 border border-slate-700 rounded-2xl p-6 shadow-xl"><h3 id="formTitle" class="font-bold text-white mb-4 border-b border-slate-700 pb-2">Update Details</h3><form id="attendanceForm" onsubmit="submitAttendance(event)" class="space-y-4"><div id="newVolProjectContainer" class="hidden mb-4 relative"><label class="block text-xs font-bold text-slate-400 mb-1">Project Group *</label><div class="relative"><input type="text" id="newVolProjectSearch" name="Project" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm text-white focus:border-green-500 outline-none" placeholder="Search Project..." onfocus="toggleProjectList(true)" oninput="filterProjects()" autocomplete="off"><ul id="projectList" class="absolute z-50 w-full bg-slate-800 border-2 border-cyan-500 rounded-xl mt-2 shadow-[0_0_20px_rgba(6,182,212,0.3)] hidden max-h-40 overflow-y-auto"></ul></div></div><div id="dynamicFields" class="grid grid-cols-1 gap-4"></div><div id="volFormStatus" class="hidden p-3 rounded-lg text-xs text-center"></div><button id="volSubmitBtn" type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg mt-4">Update Attendance</button></form></div>
     </div>

     <!-- SETTINGS VIEW -->
     <div id="view-settings" class="hidden fade-in space-y-6">
       <div class="flex items-center gap-2 mb-2"><button onclick="showView('landing')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-arrow-left"></i> Back</button><h2 class="text-xl font-bold text-purple-400">Field Configuration</h2></div><div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 shadow-xl"><p class="text-xs text-slate-400 mb-4">Select columns visible to volunteers (from Template).</p><div class="mb-2 text-right"><button onclick="loadSettings()" class="text-xs text-blue-400 hover:text-blue-300 underline">Refresh Configuration</button></div><div id="settingsLoader" class="hidden flex justify-center py-4"><div class="loader"></div></div><div id="settingsContent" class="hidden space-y-6"><div><h3 class="text-sm font-bold text-white bg-slate-700 p-2 rounded mb-2">Trainee Tab Columns</h3><div id="traineeColsContainer" class="grid grid-cols-2 gap-2 text-sm"></div></div><div><h3 class="text-sm font-bold text-white bg-slate-700 p-2 rounded mb-2">Volunteer Tab Columns</h3><div id="volColsContainer" class="grid grid-cols-2 gap-2 text-sm"></div></div><div id="settingsStatus" class="hidden p-3 rounded text-center text-xs"></div><button onclick="saveSettings()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl shadow-lg">Save Configuration</button></div></div>
     </div>
   </main>

   <!-- === FULL PAGE STATUS OVERLAY (NEW) === -->
   <div id="fullPageOverlay" class="fixed inset-0 z-[100] bg-slate-900/95 backdrop-blur-sm hidden flex flex-col items-center justify-center p-4 transition-opacity duration-300">
        <!-- LOADING STATE -->
        <div id="overlayLoading" class="flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4"></div>
            <h2 id="overlayLoadingText" class="text-xl font-bold text-white animate-pulse">Saving...</h2>
        </div>

        <!-- SUCCESS STATE -->
        <div id="overlaySuccess" class="hidden flex flex-col items-center text-center scale-100 transition-transform">
            <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(34,197,94,0.4)]">
                <i class="fa-solid fa-check text-4xl text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Success!</h2>
            <p id="overlaySuccessText" class="text-slate-300 mb-8 max-w-xs text-sm">Operation completed.</p>
            <button onclick="closeOverlay()" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-10 rounded-xl border border-slate-600 shadow-lg transition-all transform hover:scale-105">
                Close
            </button>
        </div>
        
        <!-- ERROR STATE -->
         <div id="overlayError" class="hidden flex flex-col items-center text-center">
            <div class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center mb-6 shadow-[0_0_30px_rgba(239,68,68,0.4)]">
                <i class="fa-solid fa-xmark text-4xl text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Error</h2>
            <p id="overlayErrorText" class="text-red-200 mb-8 max-w-xs text-sm">Something went wrong.</p>
            <button onclick="closeOverlay()" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-10 rounded-xl border border-slate-600 shadow-lg transition-all transform hover:scale-105">
                Close
            </button>
        </div>
    </div>

   <!-- REMINDER MODAL -->
   <div id="reminderModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
     <div class="bg-slate-800 w-full max-w-lg rounded-2xl border border-slate-700 flex flex-col max-h-[90vh] shadow-2xl">
        <div class="p-4 border-b border-slate-700 flex justify-between items-center"><h3 class="text-white font-bold"><i class="fa-regular fa-message mr-2 text-blue-400"></i>Reminder Message</h3><button onclick="closeReminderModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button></div>
        <div class="p-4 flex-grow overflow-y-auto"><p class="text-xs text-slate-400 mb-2">Copy this message to send to volunteers:</p><textarea id="modalReminderText" class="w-full h-64 bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm text-slate-300 font-mono resize-none focus:border-blue-500 outline-none" readonly></textarea></div>
        <div class="p-4 border-t border-slate-700 flex justify-end gap-2"><button onclick="closeReminderModal()" class="px-4 py-2 text-slate-300 hover:text-white text-sm font-bold">Close</button><button onclick="copyFromModal(this)" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold flex items-center gap-2"><i class="fa-regular fa-copy"></i> Copy Message</button></div>
     </div>
   </div>

   <!-- CREATE OUTING MODAL -->
   <div id="createModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-2 opacity-0 transition-opacity duration-300">
     <div class="bg-slate-800 w-full max-w-2xl rounded-2xl border border-slate-700 flex flex-col max-h-[95vh] transform scale-95 transition-transform" id="modalPanel"><div class="p-4 border-b border-slate-700 flex justify-between items-center"><h3 class="text-white font-bold">New Outing</h3><button onclick="closeModal()" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button></div><div class="p-6 overflow-y-auto"><form id="outingForm" onsubmit="handleCreate(event)" class="space-y-4"><input class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white" id="eventName" placeholder="Event Name" required><input type="text" id="eventDate" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white placeholder-slate-400 [color-scheme:dark]" placeholder="Event Date" onfocus="(this.type='date')" onblur="formatDateDisplay(this)" required><div class="text-xs text-slate-400 uppercase font-bold">Meeting (Loc & Time)</div><div class="grid grid-cols-3 gap-2"><input name="meetingLoc" class="col-span-2 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs" placeholder="Loc 1"><input name="meetingTime" type="time" class="bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs [color-scheme:dark]"></div><div class="grid grid-cols-3 gap-2"><input name="meetingLoc" class="col-span-2 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs" placeholder="Loc 2"><input name="meetingTime" type="time" class="bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs [color-scheme:dark]"></div><div class="grid grid-cols-3 gap-2"><input name="meetingLoc" class="col-span-2 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs" placeholder="Loc 3"><input name="meetingTime" type="time" class="bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs [color-scheme:dark]"></div><div class="grid grid-cols-3 gap-2"><input name="meetingLoc" class="col-span-2 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs" placeholder="Loc 4"><input name="meetingTime" type="time" class="bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs [color-scheme:dark]"></div><div class="text-xs text-slate-400 uppercase font-bold">Dismissal (Loc & Time)</div><div class="grid grid-cols-3 gap-2"><input name="dismissalLoc" class="col-span-2 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs" placeholder="Loc 1"><input name="dismissalTime" type="time" class="bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs [color-scheme:dark]"></div><div class="grid grid-cols-3 gap-2"><input name="dismissalLoc" class="col-span-2 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs" placeholder="Loc 2"><input name="dismissalTime" type="time" class="bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs [color-scheme:dark]"></div><div class="grid grid-cols-3 gap-2"><input name="dismissalLoc" class="col-span-2 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs" placeholder="Loc 3"><input name="dismissalTime" type="time" class="bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs [color-scheme:dark]"></div><div class="grid grid-cols-3 gap-2"><input name="dismissalLoc" class="col-span-2 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs" placeholder="Loc 4"><input name="dismissalTime" type="time" class="bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs [color-scheme:dark]"></div><div id="createStatusArea" class="hidden text-center text-xs p-2"></div><button id="submitCreateBtn" type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded">Generate</button></form></div></div>
   </div>

   <script>
    let currentSheetList = [];
    let selectedVolType = null;
    let allNames = [];
    let allProjects = []; 
    let currentVolTypeRequest = null;
    let isAdminAuthenticated = false;
    let pendingView = "";
    let currentActiveView = 'landing';
    let outingReminders = {};

    function showView(viewId) { currentActiveView = viewId; document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden')); document.getElementById('view-' + viewId).classList.remove('hidden'); document.getElementById('volFormStatus').classList.add('hidden'); document.getElementById('scrubStatus').classList.add('hidden'); document.getElementById('createStatusArea').classList.add('hidden'); document.getElementById('settingsStatus').classList.add('hidden'); if (viewId === 'comm' || viewId === 'volunteer') loadSheets(viewId); if (viewId === 'settings') loadSettings(); }
    function refreshApp() { const icon = document.getElementById('refreshIcon'); icon.classList.add('fa-spin'); if (currentActiveView === 'comm') loadSheets('comm'); else if (currentActiveView === 'volunteer') { loadSheets('volunteer'); resetVolForm(); } else if (currentActiveView === 'settings') loadSettings(); setTimeout(() => icon.classList.remove('fa-spin'), 1000); }
    function requestAccess(viewId) { if (isAdminAuthenticated) { showView(viewId); } else { pendingView = viewId; document.getElementById('authModal').classList.remove('hidden'); document.getElementById('adminPassword').value = ""; document.getElementById('authError').classList.add('hidden'); document.getElementById('adminPassword').focus(); } }
    function closeAuthModal() { document.getElementById('authModal').classList.add('hidden'); pendingView = ""; }
    function handleAuth(e) { e.preventDefault(); const pwd = document.getElementById('adminPassword').value; const btn = document.getElementById('authBtn'); btn.disabled = true; btn.innerText = "Checking..."; apiCall('verifyAdminPassword', pwd).then(isValid => { btn.disabled = false; btn.innerText = "Access"; if (isValid) { isAdminAuthenticated = true; const target = pendingView; closeAuthModal(); if(target) showView(target); } else { document.getElementById('authError').classList.remove('hidden'); document.getElementById('adminPassword').value = ""; } }); }
    
    // --- OVERLAY LOGIC ---
    function showOverlay(type, msg) {
        document.getElementById('fullPageOverlay').classList.remove('hidden');
        document.getElementById('overlayLoading').classList.add('hidden');
        document.getElementById('overlaySuccess').classList.add('hidden');
        document.getElementById('overlayError').classList.add('hidden');
        
        if (type === 'loading') {
            document.getElementById('overlayLoading').classList.remove('hidden');
            document.getElementById('overlayLoadingText').innerText = msg || "Processing...";
        } else if (type === 'success') {
            document.getElementById('overlaySuccess').classList.remove('hidden');
            document.getElementById('overlaySuccessText').innerText = msg;
        } else {
            document.getElementById('overlayError').classList.remove('hidden');
            document.getElementById('overlayErrorText').innerText = msg;
        }
    }

    function closeOverlay() {
        document.getElementById('fullPageOverlay').classList.add('hidden');
    }

    function showFlashMessage(elementId, message, type) { const el = document.getElementById(elementId); el.innerText = message; el.classList.remove('hidden', 'bg-green-900/20', 'text-green-400', 'border-green-500/30', 'bg-red-900/20', 'text-red-400', 'border-red-500/30'); if (type === 'success') { el.classList.add('bg-green-900/20', 'text-green-400', 'border', 'border-green-500/30'); } else { el.classList.add('bg-red-900/20', 'text-red-400', 'border', 'border-red-500/30'); } el.classList.remove('hidden'); setTimeout(() => { el.classList.add('hidden'); }, 5000); }
    function formatDateDisplay(input) { const val = input.value; if(!val) { input.type='text'; return; } const date = new Date(val); if(isNaN(date.getTime())) { input.type='text'; return; } const day = date.getDate().toString().padStart(2, '0'); const month = date.toLocaleString('default', { month: 'short' }); const year = date.getFullYear(); input.type = 'text'; input.value = `${day} ${month} ${year}`; }

    // --- LOAD SHEETS ---
    function loadSheets(viewId) {
        const selectorId = viewId === 'comm' ? 'commSheetSelector' : 'volSheetSelector';
        const loadingId = viewId === 'comm' ? 'commSheetSpinner' : 'volSheetSpinner';
        const selector = document.getElementById(selectorId);
        const spinner = document.getElementById(loadingId);
        const listContainer = document.getElementById('upcomingList');
        selector.innerHTML = '<option disabled selected>‚Üª Searching events...</option>';
        selector.disabled = true;
        if(spinner) spinner.classList.remove('hidden');
        if(viewId === 'comm' && listContainer) listContainer.innerHTML = '<p class="text-xs italic"><i class="fa-solid fa-circle-notch fa-spin"></i> Loading events...</p>';

        apiCall('getRecentOutingSheets', null).then(res => {
            if(spinner) spinner.classList.add('hidden');
            selector.disabled = false;
            selector.innerHTML = '';
            
            if(viewId === 'comm' && listContainer) {
                listContainer.innerHTML = '';
                outingReminders = {}; 
                if(res.success && res.data.length > 0) {
                    let allCards = '';
                    res.data.forEach((item, index) => {
                        allCards += `
                        <div class="flex flex-col gap-2 p-4 bg-slate-700/50 rounded-xl border border-slate-600 shadow-md relative">
                           <div class="flex justify-between items-start">
                             <div><div class="font-bold text-white text-sm">${item.displayName}</div><div class="text-slate-400 text-xs">${item.formattedDate}</div></div>
                             <div class="flex gap-2 text-xs"><a href="${item.folderUrl}" target="_blank" class="text-blue-400 hover:text-blue-300"><i class="fa-regular fa-folder-open"></i></a><a href="${item.sheetUrl}" target="_blank" class="text-green-400 hover:text-green-300"><i class="fa-regular fa-file-excel"></i></a></div>
                           </div>
                           <div id="stats-${index}" class="text-xs text-slate-500 animate-pulse mt-2">Loading stats...</div>
                           <div id="btn-group-${index}" class="hidden flex gap-2 mt-2 pt-2 border-t border-slate-600/50">
                               <button onclick="openReminderModal('${index}')" class="flex-1 bg-slate-800 hover:bg-slate-600 text-slate-300 text-xs py-2 px-3 rounded border border-slate-600 transition-colors"><i class="fa-regular fa-message mr-1"></i> Reminder Message</button>
                               <button onclick="copyReminderDirect('${index}', this)" class="bg-slate-800 hover:bg-blue-600 text-slate-300 hover:text-white text-xs py-2 px-3 rounded border border-slate-600 transition-colors"><i class="fa-regular fa-copy"></i></button>
                           </div>
                        </div>`;
                    });
                    listContainer.innerHTML = allCards;
                    res.data.forEach((item, index) => fetchOutingStats(item.sheetUrl, index));
                } else {
                    listContainer.innerHTML = '<p class="text-xs text-slate-500 italic">No upcoming outings found.</p>';
                }
            }
            if(res.success && res.data.length > 0) {
                currentSheetList = res.data;
                res.data.forEach(item => {
                    let opt = document.createElement('option');
                    opt.value = item.sheetUrl;
                    opt.text = item.displayName;
                    selector.appendChild(opt);
                });
                selector.selectedIndex = 0;
                if(viewId === 'volunteer') resetVolForm();
            } else {
                selector.innerHTML = '<option disabled selected>No upcoming events</option>';
            }
        });
    }

    function fetchOutingStats(url, index) {
        apiCall('getOutingDetails', url).then(res => {
            const container = document.getElementById(`stats-${index}`);
            const btnGroup = document.getElementById(`btn-group-${index}`);
            if(res.success) {
                let html = '<table class="w-full text-[10px] text-left border-collapse"><tr class="text-slate-400 border-b border-slate-600"><th>Proj</th><th class="text-center">Trainees</th><th class="text-center">CG</th><th class="text-center">Vols</th></tr>';
                const sortedKeys = Object.keys(res.stats).sort();
                if(sortedKeys.length === 0) {
                    html += '<tr><td colspan="4" class="text-center py-2 text-slate-500 italic">No data yet</td></tr>';
                } else {
                    for(const proj of sortedKeys) {
                        const d = res.stats[proj];
                        html += `<tr class="border-b border-slate-600/50 last:border-0"><td class="py-1 font-bold text-slate-300">${proj}</td><td class="text-center text-slate-400"><span class="text-white">${d.tY}</span>/${d.tTot}</td><td class="text-center text-slate-400 text-white">${d.cY}</td><td class="text-center text-slate-400"><span class="text-white">${d.vY}</span>/${d.vTot}</td></tr>`;
                    }
                }
                html += '</table>';
                container.innerHTML = html;
                container.classList.remove('animate-pulse');
                
                let msg = "";
                if(res.pending && res.pending.length > 0) {
                    const list = res.pending.join('\n');
                    msg = `Helloüëã, gentle reminder for volunteers of these trainees to update their attendance by tomorrow:\n${list}\n\nVolunteers please update your own attendance as well, Thank You!!üôè`;
                } else {
                    msg = "Great news! All trainees have updated their attendance.\n\nVolunteers please ensure your own attendance is updated too, Thank You!!üôè";
                }
                outingReminders[index] = msg;
                if(btnGroup) btnGroup.classList.remove('hidden');
            } else {
                container.innerHTML = '<span class="text-red-400">Error loading stats</span>';
            }
        });
    }

    function openReminderModal(index) {
        const msg = outingReminders[index];
        if(!msg) return;
        document.getElementById('modalReminderText').value = msg;
        document.getElementById('reminderModal').classList.remove('hidden');
    }
    function closeReminderModal() { document.getElementById('reminderModal').classList.add('hidden'); }
    function copyFromModal(btn) { performCopy(document.getElementById('modalReminderText').value, btn); }
    function copyReminderDirect(index, btn) { performCopy(outingReminders[index], btn); }
    function performCopy(text, btn) {
        navigator.clipboard.writeText(text).then(() => {
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
            btn.classList.add('text-green-400', 'border-green-500');
            setTimeout(() => {
                btn.innerHTML = original;
                btn.classList.remove('text-green-400', 'border-green-500');
            }, 2000);
        });
    }

     function autoScrollAndFocus(input) { toggleSearchList(true); setTimeout(() => { input.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 300); }
     function setVolType(type, btn) { selectedVolType = type; currentVolTypeRequest = type; allNames = []; document.getElementById('volNameList').innerHTML = ""; resetSearch(); document.querySelectorAll('.vol-type-btn').forEach(b => { b.classList.remove('bg-green-600', 'text-white', 'border-transparent'); b.classList.add('bg-slate-900', 'text-slate-300', 'border-slate-600'); }); btn.classList.remove('bg-slate-900', 'text-slate-300', 'border-slate-600'); btn.classList.add('bg-green-600', 'text-white', 'border-transparent'); document.getElementById('volNameSection').classList.remove('hidden'); document.getElementById('volFormContainer').classList.add('hidden'); if (type === 'volunteer') { document.getElementById('addNewVolContainer').classList.remove('hidden'); } else { document.getElementById('addNewVolContainer').classList.add('hidden'); } loadVolNames(type); }
     function resetVolForm() { document.getElementById('volNameSection').classList.add('hidden'); document.getElementById('volFormContainer').classList.add('hidden'); document.getElementById('volSubmitBtn').innerText = "Update Attendance"; selectedVolType = null; currentVolTypeRequest = null; allNames = []; document.querySelectorAll('.vol-type-btn').forEach(b => { b.classList.remove('bg-green-600', 'text-white', 'border-transparent'); b.classList.add('bg-slate-900', 'text-slate-300', 'border-slate-600'); }); resetSearch(); }
     function resetSearch() { const input = document.getElementById('volNameSearch'); input.value = ""; toggleSearchList(false); document.getElementById('clearSearchBtn').classList.add('hidden'); }
     function loadVolNames(requestedType) { const url = document.getElementById('volSheetSelector').value; const loader = document.getElementById('nameLoader'); const input = document.getElementById('volNameSearch'); if(!url || !requestedType || url === "Select an Event") return; input.placeholder = "Loading names..."; input.disabled = true; loader.classList.remove('hidden'); apiCall('getNamesList', { url: url, type: requestedType }).then(res => { if (currentVolTypeRequest !== requestedType) return; loader.classList.add('hidden'); input.disabled = false; input.placeholder = "Type to search..."; if(res.success) allNames = res.names; }); }
     function toggleSearchList(show) { const list = document.getElementById('volNameList'); if(show) { list.classList.remove('hidden'); if(document.getElementById('volNameSearch').value.length > 0) filterNames(); } else { setTimeout(() => list.classList.add('hidden'), 200); } }
     function clearSearch() { document.getElementById('volNameSearch').value = ""; filterNames(); document.getElementById('volFormContainer').classList.add('hidden'); document.getElementById('clearSearchBtn').classList.add('hidden'); }
     function filterNames() { const input = document.getElementById('volNameSearch'); const filter = input.value.toLowerCase(); const list = document.getElementById('volNameList'); const clearBtn = document.getElementById('clearSearchBtn'); if(filter.length > 0) { list.classList.remove('hidden'); clearBtn.classList.remove('hidden'); } else { list.classList.add('hidden'); clearBtn.classList.add('hidden'); return; } list.innerHTML = ""; const matches = allNames.filter(n => n.toLowerCase().includes(filter)); matches.forEach(name => { const li = document.createElement('li'); li.className = "px-4 py-3 bg-slate-800 text-slate-200 border-b border-slate-600 hover:bg-cyan-600 hover:text-white cursor-pointer text-sm transition-colors last:border-0"; li.innerText = name; li.onmousedown = () => selectName(name); list.appendChild(li); }); if(matches.length === 0) { const li = document.createElement('li'); li.className = "px-4 py-3 text-sm text-slate-500 italic"; li.innerText = "No matches found."; list.appendChild(li); } }
     function selectName(name) { document.getElementById('volNameSearch').value = name; document.getElementById('volNameList').classList.add('hidden'); loadVolData(name, false); }
     function showAddNewForm() { const input = document.getElementById('volNameSearch'); input.value = ""; document.getElementById('volNameList').classList.add('hidden'); loadVolData(null, true); }
     function getValueFuzzy(dataObj, lookupKey) { if (!dataObj) return ""; if (dataObj[lookupKey] !== undefined) return dataObj[lookupKey]; const cleanLookup = lookupKey.toLowerCase().replace(/[^a-z0-9]/g, ""); for (let key in dataObj) { const cleanKey = key.toLowerCase().replace(/[^a-z0-9]/g, ""); if (cleanKey === cleanLookup) return dataObj[key]; if (cleanLookup.includes("caregiver") && cleanKey.includes("caregiver")) return dataObj[key]; } return ""; }
     function toggleDependentFields(el) { const val = el.value; const deps = document.querySelectorAll('.attendance-dependent'); deps.forEach(d => { if(val === 'N') d.classList.add('hidden'); else d.classList.remove('hidden'); }); }
     function toggleProjectList(show) { const list = document.getElementById('projectList'); if(show) { list.classList.remove('hidden'); filterProjects(); } else { setTimeout(() => list.classList.add('hidden'), 200); } }
     function filterProjects() { const input = document.getElementById('newVolProjectSearch'); const filter = input.value.toLowerCase(); const list = document.getElementById('projectList'); list.innerHTML = ""; const matches = allProjects.filter(p => p.toLowerCase().includes(filter)); matches.forEach(proj => { const li = document.createElement('li'); li.className = "px-4 py-3 bg-slate-800 text-slate-200 border-b border-slate-600 hover:bg-cyan-600 hover:text-white cursor-pointer text-sm transition-colors last:border-0"; li.innerText = proj; li.onmousedown = () => selectProject(proj); list.appendChild(li); }); if(matches.length === 0) { const li = document.createElement('li'); li.className = "px-4 py-3 text-sm text-slate-500 italic"; li.innerText = "No matches found."; list.appendChild(li); } }
     function selectProject(proj) { document.getElementById('newVolProjectSearch').value = proj; document.getElementById('projectList').classList.add('hidden'); }
     function loadVolData(name, isManualNew) { const url = document.getElementById('volSheetSelector').value; const container = document.getElementById('volFormContainer'); const fieldsDiv = document.getElementById('dynamicFields'); const title = document.getElementById('formTitle'); const submitBtn = document.getElementById('volSubmitBtn'); const projectContainer = document.getElementById('newVolProjectContainer'); container.classList.remove('hidden'); fieldsDiv.innerHTML = '<div class="text-center"><div class="loader inline-block"></div></div>'; if (isManualNew) { title.innerText = "Add New Volunteer"; submitBtn.innerText = "Add New Volunteer & Update Attendance"; projectContainer.classList.remove('hidden'); document.getElementById('newVolProjectSearch').value = ""; document.getElementById('newVolProjectSearch').required = true; } else { title.innerText = "Loading..."; submitBtn.innerText = "Update Attendance"; projectContainer.classList.add('hidden'); document.getElementById('newVolProjectSearch').required = false; } apiCall('getPersonData', { url: url, type: selectedVolType, name: name }).then(res => { fieldsDiv.innerHTML = ''; if(res.success) { const data = res.data; const config = res.config; const meetingOpts = res.meetingOpts || []; const dismissalOpts = res.dismissalOpts || []; const isNew = res.isNew || isManualNew; allProjects = res.projectOpts || []; title.innerHTML = isNew ? `Add New: <span class="text-green-400">Volunteer</span>` : `Update: <span class="text-blue-400">${name}</span>`; if(isNew) submitBtn.innerText = "Add New Volunteer & Update Attendance"; else submitBtn.innerText = "Update Attendance"; let fieldsToShow = (config && config.length > 0) ? config : res.headers.map(h => h.replace(/\[.*?\]/g,"").trim()); if (isNew) { const nameFieldExists = fieldsToShow.some(f => f.toLowerCase().includes("name")); if (!nameFieldExists) { const rawNameHeader = res.headers.find(h => h.toLowerCase().includes("name")) || "Volunteer Name"; fieldsToShow.unshift(rawNameHeader.replace(/\[.*?\]/g,"").trim()); } } fieldsToShow.forEach(header => { let val = isNew ? "" : (getValueFuzzy(data, header)); let cleanH = header.toLowerCase(); let isNameField = cleanH.includes("name"); if(isNew && cleanH.includes("project")) return; let isReadOnly = isNameField && !isNew; if(isNew && isNameField) val = ""; if(!isNew && isNameField) val = name; let inputHtml = ""; let wrapperClass = "mb-1"; if (!isNameField && !cleanH.includes("attending")) { wrapperClass += " attendance-dependent"; } if (cleanH.includes("attending")) { inputHtml = ` <select name="${header}" onchange="toggleDependentFields(this)" class="w-full bg-slate-900 border border-slate-600 text-white rounded p-2 text-sm focus:border-green-500"> <option value="" ${val===""?"selected":""}>Select...</option> <option value="Y" ${val.toLowerCase()==="y"?"selected":""}>Y (Yes)</option> <option value="N" ${val.toLowerCase()==="n"?"selected":""}>N (No)</option> </select>`; } else if (cleanH.includes("meeting location") || cleanH.includes("dismissal location")) { const isDismissal = cleanH.includes("dismissal"); const optionsList = isDismissal ? dismissalOpts : meetingOpts; const placeholder = isDismissal ? "Select Dismissal..." : "Select Meeting..."; let optionsHtml = optionsList.map(opt => { const isSelected = val.toString().trim().toLowerCase() === opt.toString().trim().toLowerCase(); return `<option value="${opt}" ${isSelected ? "selected" : ""}>${opt}</option>`; }).join(""); const valTrimmed = val.toString().trim(); if (valTrimmed !== "") { const listHasValue = optionsList.some(opt => opt.toString().trim().toLowerCase() === valTrimmed.toLowerCase()); if (!listHasValue) { optionsHtml += `<option value="${val}" selected>${val} (Current)</option>`; } } inputHtml = ` <select name="${header}" class="w-full bg-slate-900 border border-slate-600 text-white rounded p-2 text-sm focus:border-green-500"> <option value="">${placeholder}</option> ${optionsHtml} </select>`; } else { let type = "text"; if(cleanH.includes("date")) type = "date"; if(cleanH.includes("time")) type = "time"; inputHtml = `<input name="${header}" type="${type}" value="${val}" ${isReadOnly ? 'readonly' : ''} class="w-full bg-slate-900 border ${isReadOnly ? 'border-slate-700 text-slate-500' : 'border-slate-600 text-white focus:border-green-500'} rounded p-2 text-sm [color-scheme:dark]">`; } fieldsDiv.innerHTML += `<div class="${wrapperClass}"><label class="block text-xs font-bold text-slate-400 mb-1">${header}</label>${inputHtml}</div>`; }); const attSelect = document.querySelector('select[name*="Attending"], select[name*="attending"]'); if(attSelect) toggleDependentFields(attSelect); } else { fieldsDiv.innerHTML = '<div class="text-red-400">Error: ' + res.message + '</div>'; } }).getPersonData(url, selectedVolType, name); }
     
     // --- UPDATED SUBMIT FUNCTION WITH OVERLAY ---
     function submitAttendance(e) { 
        e.preventDefault(); 
        const btn = document.getElementById('volSubmitBtn'); 
        
        // Show Loading Overlay
        showOverlay('loading', 'Saving Attendance...');
        
        const formEl = document.getElementById('attendanceForm'); 
        const formData = new FormData(formEl); 
        let dataObj = {}; 
        formData.forEach((value, key) => dataObj[key] = value); 
        let target = document.getElementById('volNameSearch').value; 
        if (!target || target === "") { for (let k in dataObj) { if (k.toLowerCase().includes("name")) { target = dataObj[k]; break; } } } 
        const payload = { sheetUrl: document.getElementById('volSheetSelector').value, type: selectedVolType, data: dataObj, targetName: target }; 
        
        apiCall('submitAttendanceData', payload).then(res => { 
            if(res.success) {
                showOverlay('success', res.message);
                if(selectedVolType === 'volunteer') { 
                    if(res.message.includes("added")) { 
                        resetVolForm(); 
                        document.getElementById('volNameSearch').value = ""; 
                    } 
                    const url = document.getElementById('volSheetSelector').value; 
                    apiCall('getNamesList', { url: url, type: 'volunteer' }).then(r => { if(r.success) allNames = r.names; }); 
                } 
            } else {
                showOverlay('error', res.message);
            }
        }); 
     }

     // --- UPDATED CREATE FUNCTION WITH OVERLAY ---
     function handleCreate(e) { 
        e.preventDefault(); 
        showOverlay('loading', 'Creating Outing...');
        
        const form = document.getElementById('outingForm'); 
        const formData = { eventName: document.getElementById('eventName').value, eventDate: document.getElementById('eventDate').value, meetingLocs: Array.from(document.getElementsByName('meetingLoc')).map(i=>i.value), meetingTimes: Array.from(document.getElementsByName('meetingTime')).map(i=>i.value), dismissalLocs: Array.from(document.getElementsByName('dismissalLoc')).map(i=>i.value), dismissalTimes: Array.from(document.getElementsByName('dismissalTime')).map(i=>i.value), }; 
        
        apiCall('createOuting', formData).then(res => { 
            if(res.success) { 
                showOverlay('success', 'Outing Created Successfully!');
                closeModal(); 
                loadSheets('comm'); 
            } else { 
                showOverlay('error', res.message);
            } 
        }); 
     }

     function handlePair() { const url = document.getElementById('commSheetSelector').value; const btn = document.getElementById('scrubBtn'); const status = document.getElementById('scrubStatus'); if(!url || url.includes("Select")) return alert("Select a sheet first"); btn.disabled = true; btn.innerText = "Pairing..."; status.classList.add('hidden'); apiCall('runAutoPairing', url).then(res => { btn.disabled = false; btn.innerText = "Pair Now"; showFlashMessage('scrubStatus', res.message, res.success ? 'success' : 'error'); }); }
     function handleGroup() { const url = document.getElementById('commSheetSelector').value; const btn = document.getElementById('groupBtn'); if(!url || url.includes("Select")) return alert("Select a sheet first"); btn.disabled = true; btn.innerText = "Grouping..."; apiCall('runAutoGrouping', url).then(res => { btn.disabled = false; btn.innerText = "Group Now"; showFlashMessage('scrubStatus', res.message, res.success ? 'success' : 'error'); }); }
     function loadSettings() { const loader = document.getElementById('settingsLoader'); const content = document.getElementById('settingsContent'); loader.classList.remove('hidden'); content.classList.add('hidden'); apiCall('getAppSettings', null).then(savedSettings => { apiCall('getTemplateHeaders', null).then(res => { document.getElementById('settingsLoader').classList.add('hidden'); document.getElementById('settingsContent').classList.remove('hidden'); if(res.success) { renderSettingsCheckboxes(res.tHeaders, res.vHeaders, savedSettings); } else { alert("Error loading template headers: " + res.message); } }).getTemplateHeaders(); }).getAppSettings(); }
     function renderSettingsCheckboxes(tHeaders, vHeaders, saved) { const tContainer = document.getElementById('traineeColsContainer'); const vContainer = document.getElementById('volColsContainer'); tContainer.innerHTML = ''; vContainer.innerHTML = ''; tHeaders.forEach(h => { let checked = (saved.traineeCols.includes(h) || saved.traineeCols.length === 0) ? 'checked' : ''; tContainer.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" class="t-col-check accent-purple-500" value="${h}" ${checked}> <span class="text-slate-300">${h}</span></label>`; }); vHeaders.forEach(h => { let checked = (saved.volCols.includes(h) || saved.volCols.length === 0) ? 'checked' : ''; vContainer.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" class="v-col-check accent-purple-500" value="${h}" ${checked}> <span class="text-slate-300">${h}</span></label>`; }); }
     function saveSettings() { const tCols = Array.from(document.querySelectorAll('.t-col-check:checked')).map(cb => cb.value); const vCols = Array.from(document.querySelectorAll('.v-col-check:checked')).map(cb => cb.value); const settings = { traineeCols: tCols, volCols: vCols }; showFlashMessage('settingsStatus', "Saving...", 'success'); apiCall('saveAppSettings', settings).then(res => { showFlashMessage('settingsStatus', res.message, 'success'); }).saveAppSettings(settings); }
     const modal = document.getElementById('createModal'); const modalPanel = document.getElementById('modalPanel'); function openModal() { modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modalPanel.classList.remove('scale-95'); modalPanel.classList.add('scale-100'); }, 10); } function closeModal() { modal.classList.add('opacity-0'); modalPanel.classList.remove('scale-100'); modalPanel.classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 300); } 
   </script>
</body>
</html>
